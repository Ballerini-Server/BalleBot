import Discord from 'discord.js';
import { getUserOfCommand } from '../../../utils/commandsFunctions/getUserMention/getUserOfCommand.js';
import { confirmMessage } from '../../../utils/commandsFunctions/confirmMessage/confirmMessage.js';
import { helpWithASpecificCommand } from '../../everyone/commandsCommon/help.command.js';
import Icons from '../../../utils/commandsFunctions/layoutEmbed/iconsMessage.js';
import Colors from '../../../utils/commandsFunctions/layoutEmbed/colors.js';
import { uploadImage } from '../../../services/APIs/uploadImageImgur/uploadImage.js';
import { verifyWarnCountUser } from '../../../utils/verifications/verifyWarnCountUser/verifyWarnCountUser.js';

export default {
  name: 'warn',
  description: `<prefix>warn @Usu√°rios/TAGs/Nomes/IDs/Cita√ß√µes <motivo> para alertar e punir usu√°rios`,
  permissions: ['padawans'],
  aliases: ['addwarn', 'advertencia', 'avisar'],
  category: 'Modera√ß√£o ‚öîÔ∏è',
  run: async ({ message, client, args, prefix }) => {
    const { users, restOfMessage } = await getUserOfCommand(
      client,
      message,
      prefix
    );

    if (!args[0] && !users) {
      const [command] = message.content.slice(prefix.length).split(/ +/);
      helpWithASpecificCommand(command, client, message);
      return;
    }

    if (users === undefined) {
      return message.channel
        .send({
          content: `${message.author}`,
          embeds: [
            {
              color: Colors.pink_red,
              thumbnail: Icons.erro,
              author: {
                name: message.author.tag,
                icon_url: message.author.displayAvatarURL({ dynamic: true }),
              },
              title: `N√£o encontrei o usu√°rio!`,
              description: `*Tente usar**\`\`\`${prefix}warn @Usu√°rios/TAGs/Nomes/IDs/Cita√ß√µes <motivo>\`\`\``,
              timestamp: new Date(),
            },
          ],
        })
        .then((msg) => setTimeout(() => msg.delete(), 15000));
    }

    let reason = `${restOfMessage}` || '<Motivo n√£o especificado>';
    const attachmentsLinks = message.attachments.map((anex) => anex.url);

    if (attachmentsLinks.length > 0) {
      if (attachmentsLinks.length > 3) {
        return message.channel.send({
          content: `${message.author} Voc√™ pode enviar no m√°ximo 3 imagens como prova`,
        });
      }
      reason += `\n**Arquivos anexados**: ${attachmentsLinks.join('\n')}`;
    }

    const messageAnt = await message.channel.send({
      embeds: [
        {
          color: Colors.pink_red,
          thumbnail: Icons.warn,
          author: {
            name: message.author.tag,
            icon_url: message.author.displayAvatarURL({ dynamic: true }),
          },
          title: `Voc√™ est√° preste a avisar os Usu√°rios:`,
          description: `**Usu√°rios: ${users.join('|')}**
**Pelo Motivo de: **
${reason}

‚úÖ Para confirmar
‚ùé Para cancelar
üïµÔ∏è‚Äç‚ôÄÔ∏è Para confirmar e n√£o avisa na DM do usu√°rio`,
          timestamp: new Date(),
        },
      ],
    });

    await confirmMessage(message, messageAnt).then(async (res) => {
      await messageAnt.delete();
      if (res) {
        const inviteDm = res !== 'anonimo';
        const guildIdDatabase = new client.Database.table(
          `guild_id_${message.guild.id}`
        );

        const channelLog = client.channels.cache.get(
          guildIdDatabase.get('channel_log')
        );

        users.forEach(async (user) => {
          const memberUser = client.guilds.cache
            .get(message.guild.id)
            .members.cache.get(user.id);
          if (!memberUser) {
            return message.channel.send({
              content:
                'n√£o encontrei o usu√°rio no servidor, talvez ele n√£o esteja entre n√≥s',
            });
          }
          if (user.id === message.guild.me.id) {
            return message.channel
              .send({
                content: `${message.author}`,
                embeds: [
                  {
                    thumbnail: Icons.erro,
                    author: {
                      name: message.author.tag,
                      icon_url: message.author.displayAvatarURL({
                        dynamic: true,
                      }),
                    },
                    color: Colors.pink_red,
                    title: `Hey, voc√™ n√£o pode avisar eu mesma, isso n√£o √© legal :(`,
                    timestamp: new Date(),
                  },
                ],
              })
              .then((msg) => setTimeout(() => msg.delete(), 15000));
          }
          if (
            memberUser.roles.highest.position >=
              message.member.roles.highest.position &&
            !(message.member.id === message.guild.ownerId)
          ) {
            return message.channel
              .send({
                content: `${message.author}`,
                embeds: [
                  {
                    color: Colors.pink_red,
                    thumbnail: Icons.erro,
                    author: {
                      name: message.author.tag,
                      icon_url: message.author.displayAvatarURL({
                        dynamic: true,
                      }),
                    },
                    title: `Voc√™ n√£o tem permiss√£o para avisar o usu√°rio`,
                    description: `O usu√°rio ${user} est√° acima ou no mesmo cargo que voc√™, por isso n√£o podes adicionar um aviso a ele`,
                    timestamp: new Date(),
                  },
                ],
              })
              .then((msg) => setTimeout(() => msg.delete(), 15000));
          }
          let reasonOfWarn = `${restOfMessage}` || '<Motivo n√£o especificado>';

          if (attachmentsLinks.length > 0) {
            await uploadImage(message).then((linksImages) => {
              reasonOfWarn += `\n**Arquivos anexados**:\n${linksImages.join(
                '\n'
              )}`;
            });
          }
          function messageSucess() {
            return {
              color: Colors.pink_red,
              thumbnail: Icons.sucess,
              author: {
                name: message.author.tag,
                icon_url: message.author.displayAvatarURL({ dynamic: true }),
              },
              title: `O usu√°rio ${user.tag} foi avisado!`,
              description: `**Pelo Motivo de: **\n${reasonOfWarn}`,
              footer: {
                text: `ID do usu√°rio avisado: ${user.id}`,
              },
              timestamp: new Date(),
            };
          }
          if (channelLog) {
            channelLog
              .send({ content: `${message.author}`, embeds: [messageSucess()] })
              .catch(() => {
                const buffer = Buffer.from(reason);
                const attachment = new Discord.MessageAttachment(
                  buffer,
                  `ban_of_${user.tag}.txt`
                );
                message.channel.send({
                  content: `${user} O usu√°rio possui um motivo muito grande e por esse motivo enviei um arquivo para voc√™ ver todo o motivo`,
                  files: [attachment],
                });
              });
          } else {
            message.channel
              .send({ content: `${message.author}`, embeds: [messageSucess()] })
              .then((msg) => setTimeout(() => msg.delete(), 15000));
          }
          if (inviteDm) {
            user
              .send({
                embeds: [
                  {
                    color: Colors.pink_red,
                    thumbnail: message.guild.iconURL(),
                    title: `Voc√™ recebeu um warn do servidor **${message.guild}**`,
                    description: `**Descri√ß√£o: **
${reason}
**Para rever seu caso fale com: ${message.author.tag}**`,
                    footer: { text: `ID do usu√°rio: ${user.id}` },
                    timestamp: new Date(),
                  },
                ],
              })
              .catch(() =>
                message.channel
                  .send({
                    content: `${message.author}`,
                    embeds: [
                      {
                        author: {
                          name: message.author.tag,
                          icon_url: message.author.displayAvatarURL({
                            dynamic: true,
                          }),
                        },
                        thumbnail: user.displayAvatarURL({ dynamic: true }),
                        color: Colors.pink_red,
                        title: `N√£o foi poss√≠vel avisar na DM do usu√°rio ${user.tag}!`,
                      },
                    ],
                  })
                  .then((msg) => setTimeout(() => msg.delete(), 15000))
              );
          }

          if (guildIdDatabase.has(`user_id_${user.id}`)) {
            guildIdDatabase.push(`user_id_${user.id}.autor`, message.author.id);
            guildIdDatabase.push(`user_id_${user.id}.reasons`, reasonOfWarn);
            guildIdDatabase.push(
              `user_id_${user.id}.dataReasonsWarns`,
              new Date()
            );
          } else {
            guildIdDatabase.set(`user_id_${user.id}`, {
              id: user.id,
              reasons: [reasonOfWarn],
              autor: [message.author.id],
              dataReasonsWarns: [new Date()],
            });
          }
          verifyWarnCountUser(client, message, user.id);
        });
      }
    });
  },
};
